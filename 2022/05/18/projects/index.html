<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>XingYeBlog | XingYeBlog</title><meta name="author" content="Xing Ye,632885485@qq.com"><meta name="copyright" content="Xing Ye"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="超管项目遇到问题：  代码问题 写好注释 代码规范，变量、函数名，eslint   需求问题 部分功能实现困难，比如 canvas 地图的点位和比例计算：理清思路，多做推理和演算 canvas 绘制复杂，很难处理事件：采用 konva 组件多，数据杂，context 不合适：先使用 redux，但类型不好且冗余代码过多：recoil    项目重点：  技术选型，即 konva 和其他 canva">
<meta property="og:type" content="article">
<meta property="og:title" content="XingYeBlog">
<meta property="og:url" content="http://example.com/2022/05/18/projects/index.html">
<meta property="og:site_name" content="XingYeBlog">
<meta property="og:description" content="超管项目遇到问题：  代码问题 写好注释 代码规范，变量、函数名，eslint   需求问题 部分功能实现困难，比如 canvas 地图的点位和比例计算：理清思路，多做推理和演算 canvas 绘制复杂，很难处理事件：采用 konva 组件多，数据杂，context 不合适：先使用 redux，但类型不好且冗余代码过多：recoil    项目重点：  技术选型，即 konva 和其他 canva">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/codes1.jpg">
<meta property="article:published_time" content="2022-05-18T02:57:57.356Z">
<meta property="article:modified_time" content="2023-04-19T06:42:14.675Z">
<meta property="article:author" content="Xing Ye">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/codes1.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://example.com/2022/05/18/projects/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'XingYeBlog',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-19 14:42:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/pinkstar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/codes1.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">XingYeBlog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-18T02:57:57.356Z" title="发表于 2022-05-18 10:57:57">2022-05-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-19T06:42:14.675Z" title="更新于 2023-04-19 14:42:14">2023-04-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="超管项目"><a href="#超管项目" class="headerlink" title="超管项目"></a>超管项目</h1><p>遇到问题：</p>
<ul>
<li>代码问题<ul>
<li>写好注释</li>
<li>代码规范，变量、函数名，eslint</li>
</ul>
</li>
<li>需求问题<ul>
<li>部分功能实现困难，比如 canvas 地图的点位和比例计算：理清思路，多做推理和演算</li>
<li>canvas 绘制复杂，很难处理事件：采用 konva</li>
<li>组件多，数据杂，context 不合适：先使用 redux，但类型不好且冗余代码过多：recoil</li>
</ul>
</li>
</ul>
<p>项目重点：</p>
<ul>
<li>技术选型，即<ul>
<li>konva 和其他 canvas 框架的技术选型，以及 canvas 本身的 api、性能优化相关</li>
<li>recoil 和其他状态管理库的技术选型（可以说的：redux、mobx、zustand、joita 等），从哪些方面考虑，这些状态管理库的通用特点有哪些。（可以参考那篇飞书文档）</li>
</ul>
</li>
<li>项目规范<ul>
<li>代码可读性、规范性、复用性各方面</li>
</ul>
</li>
</ul>
<h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h3 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h3><p>规范主要有四类规范：</p>
<ul>
<li>（文件）命名规范</li>
<li>ts 规范</li>
<li>React 规范</li>
<li>git 规范</li>
</ul>
<p>规范来源：</p>
<ul>
<li>部门规范</li>
<li>公司内规范</li>
<li>个人建议/自用规范</li>
</ul>
<h4 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h4><ol>
<li>文件名、目录：</li>
</ol>
<ul>
<li>kebab-case 形式。语义要明确，比如 modal 组件的文件名称都叫 modal-xxx</li>
<li>不要简写</li>
<li>目录要对于复数结构采取复数形式。</li>
</ul>
<h4 id="ts-规范"><a href="#ts-规范" class="headerlink" title="ts 规范"></a>ts 规范</h4><ol>
<li>类的私有方法前要加 private 和下划线</li>
<li>接口 PascalCase，前面要加 I</li>
<li>枚举 PascalCase</li>
<li>常量使用 UPPER_CASE ，禁用魔法数字和魔法字符串</li>
<li>注释：</li>
</ol>
<p>需要为以下内容添加注释</p>
<ul>
<li>class<ul>
<li>需要在 class 的顶部添加注释，说明该类的主要作用，比如为 React class/hooks component 添加注释</li>
<li>需要为 class 中的每个成员变量添加注释说明字段含义，无论是 public、protected、private</li>
<li>需要为 class 中的每个函数添加注释，具体参见下方 function</li>
</ul>
</li>
<li>enum<ul>
<li>需要为枚举添加注释，以及为枚举中的每个成员添加注释说明</li>
</ul>
</li>
<li>interface<ul>
<li>需要为 interface 添加注释，并为其中的字段添加注释说明，如果该 interface 对应了后台接口，还需要链接相关接口文档</li>
</ul>
</li>
<li>function<ul>
<li>需要注释说明函数的作用，每个入参的含义并给出相关示例，说明返回值含义及给出示例，对于复杂的逻辑，需要给出该函数实现的核心逻辑思想<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回两个数的平均值 ---- 函数作用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>x 第一个数，例如 1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>y 第二个数，例如 2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span>“x”和“y”的算数平均值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAverage</span>(<span class="params">x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (x + y) / <span class="number">2.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>全局 let/const<ul>
<li>需要为 class 或 function 外部的 let/const 变量添加注释</li>
</ul>
</li>
</ul>
<p>格式遵循 TSDoc</p>
<ol start="6">
<li>尽量不使用 any，可以用 unknown 代替</li>
<li>字符串拼接统一使用模版字符串</li>
<li>使用 interface 定义对象结构体，而不是使用 type，对于 interface 接口名前要有 I</li>
<li>使用 async/await 代替 Promise，并且避免 async/await 与 Promise 混用</li>
<li>使用统一的 import 顺序，按 内置库 → 外部库 → 内部模块 的顺序进行 import。</li>
</ol>
<h4 id="react-项目规范"><a href="#react-项目规范" class="headerlink" title="react 项目规范"></a>react 项目规范</h4><ol>
<li>useCallback、useMemo、React.memo 一起结合使用才能减少不必要的子组件渲染，分工如下：</li>
</ol>
<ul>
<li>父组件：在父组件中应该使用 useCallback() 和 useMemo() 尽量确保相应的 fn 或 value 不变，这样才能确保传递给子组件的 prop 不变。</li>
<li>子组件：在子组件中应该使用 React.memo() 包裹原始的子函数组件，从而可以通过利用浅比较 props 的方式尽量使得子组件在 prop 没有发生变化时不进行渲染。</li>
</ul>
<ol start="2">
<li>不要在 JSX 中写 JavaScript/TypeScript<br>在 JSX 中写代码，会让调试变得困难。(这个可以详细说一下)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bad</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  <span class="xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">    &#123;users.map((user) =&gt; (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">a</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">onClick</span>=<span class="string">&#123;(event)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="xml">          console.log(event.target); //bad</span></span><br><span class="line"><span class="xml">        &#125;&#125;</span></span><br><span class="line"><span class="xml">        key=&#123;user.id&#125;</span></span><br><span class="line"><span class="xml">      &gt;</span></span><br><span class="line"><span class="xml">        &#123;user.name&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    ))&#125;</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Good</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onClickHandler = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event.target);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userLinks = users.map(<span class="function">(<span class="params">user</span>) =&gt;</span> (</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;onClickHandler&#125;</span> <span class="attr">key</span>=<span class="string">&#123;user.id&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="xml">    &#123;user.name&#125;&#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="xml"><span class="tag">&lt;&gt;</span>&#123;userLinks&#125;<span class="tag">&lt;/&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>husky：确保在提交代码时也能够运行 lint 检查</li>
</ol>
<h4 id="git-规范"><a href="#git-规范" class="headerlink" title="git 规范"></a>git 规范</h4><p>按照 git 工作流的形式，主要是四个分支</p>
<p><img src="https://pic.imgdb.cn/item/641835e4a682492fcc153b12.jpg"></p>
<ul>
<li>master：<ul>
<li>所有线上的发布都必须基于 master 分支，不能基于 release、feature、hotfix 分支</li>
<li>无论是 release 还是 hotfix 合并到 master，在 master 分支合并后，需要基于 package.json 中的 version 对 master 打 tag，注意只能对 master 分支打 tag，不能对 release、feature、hotfix 分支打 tag</li>
<li>如果在某一时刻同时有 release1 和 release2 两个分支在开发，当 release1 测试通过并 merge 到 master 后，需要将 master 再 merge 回 release2，确保 release2 最新</li>
</ul>
</li>
<li>Release：<ul>
<li>从 master checkout 创建</li>
<li>创建后更改 package.json 的 version，version 的组成形式为 majorVersion.minorVersion.patchVersion，创建 release 分支时应该更改 minor version，比如从 0.5.1 改为 0.6.0</li>
<li>release 分支是受保护分支，严禁直接提交代码到 release 分支，只能通过 MR 对 release 代码进行变更</li>
<li>当 feature 分支完成一块相对独立的功能时，就可以从 feature 分支 发起 merge request 到 release 分支</li>
<li>提测前需要确保所有 feature 分支的代码已经合并进 release 分支，然后将 release 分支部署到 boe 环境</li>
<li>发布到线上前将 release 分支 merge 到 master，此处的 code reveiw 只需要大体过一下即可，因为 diff 内容都在 feature 往 release 分支合并时仔细 review 过了</li>
<li>如果某一个时刻基于 release1 分支有 feature1 和 feature2 两个分支，当 feature1 通过 code review 合并到 release1 后，也需要将 release1 合并回 feature2</li>
<li>需要注意的是，机器人前端项目每次给 QA deb 包进行测试前，都首先要确保 package.json 中的 version 变化了，因为机器人前端项目目前是根据 package.json 中的 version 生成 deb 包的版本</li>
</ul>
</li>
<li>Feature<ul>
<li>所有的 feature 分支都应该从 release 分支 checkout 创建，即便这次 release 分支只有一个开发人员也应如此，feature 分支需要包含个人名称简写</li>
<li>提测前将 feature 分支 merge 到 release 分支，此处的 MR 需要严格 code review</li>
</ul>
</li>
<li>Hotfix<ul>
<li>从 master checkout 创建，然后需要修改 package.json 中的 version，创建 hotfix 分支时应该更改 patch version，比如从 0.6.0 改为 0.6.1</li>
<li>修改完成后创建 merge request 到 master</li>
<li>注意在将 hotfix 分支合并到 master 分之后，记得更新 release 分支以及 feature 分支</li>
</ul>
</li>
</ul>
<h4 id="eslint"><a href="#eslint" class="headerlink" title="eslint"></a>eslint</h4><p>使用<code>eslint --init</code>即可初始化配置。</p>
<p>配置内容</p>
<ul>
<li>eslintrecommended、reactrecommended、tsrecommended</li>
<li>@byted/eslint-config：公司内部的 eslint 推荐配置</li>
<li>自定义的一些<ul>
<li>禁用魔法数字</li>
<li>useState 建议是<code>[xxxState,setXxxState]</code>的形式，以及 useRef 必须是 xxxRef 的形式，useReducer 必须返回 xxxReducer 的形式。这三个都是自定义的插件，参考工程化中编写插件的部分。</li>
</ul>
</li>
</ul>
<p>关于 plugin 的</p>
<h4 id="husky"><a href="#husky" class="headerlink" title="husky"></a>husky</h4><p>配置 husky 在 eslint 校验通过之前不允许提交。<br><a target="_blank" rel="noopener" href="https://typicode.github.io/husky/#/">husky 文档</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7038143752036155428#heading-9">husky 配置</a></p>
<p>husky 是一个操作 git 钩子的工具。可以使用预设的钩子，在 git 各种操作的时间进行补捕获和拦截。<br>比如，在 pre-commit 阶段，即提交之前先进行 lint 的检查，如果不通过就不允许提交。</p>
<blockquote>
<p>Git hooks 是一种在 Git 仓库中预定义的脚本，它可以在特定的 Git 操作时自动执行。Git hooks 可以在 Git 操作之前或之后执行一些自定义代码，比如在代码提交之前运行测试，或者在代码合并之前运行代码格式化工具等。<br>在 Git 中，每个仓库都有一个 .git/hooks 目录，其中包含了一些可用的 Git hooks 脚本模板。这些模板可以被复制并重命名为不同的钩子名称，然后在其中编写脚本代码来实现自定义操作。Git hooks 脚本必须是可执行的（即要有执行权限）。<br>husky 的核心代码其实很简单，就是通过配置 git hooks 的方式来实现要在 git hooks 阶段执行的任务。</p>
</blockquote>
<p>配置流程：</p>
<ol>
<li>安装 lint-staged、husky、commitlint</li>
<li>配置 husky 在 pre-commit 阶段进行 line-stage 检查：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn husky add .husky/pre-commit &quot;npx lint-staged&quot;</span><br></pre></td></tr></table></figure>

<p>当然还要配置.lintstagedrc.json 文件控制检查和操作方式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;*.&#123;js,jsx,ts,tsx&#125;&quot;</span>: [<span class="string">&quot;eslint  --fix&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>commitlint 配置 commit 规范<br><a target="_blank" rel="noopener" href="https://commitlint.js.org/#/?id=getting-started">commitlint 文档</a></li>
</ol>
<p>使用 husky 在 commit-msg 钩子上增加对 commit 的检查：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">husky add .husky/commit-msg &#x27;npx --no-install commitlint --edit &quot;$1&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>创建 commitlint.config.js，使用预设：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123; <span class="attr">extends</span>: [<span class="string">&quot;@commitlint/config-conventional&quot;</span>] &#125;;</span><br></pre></td></tr></table></figure>

<p>这个预设比较简单，就是要求提交前面必须是<code>fix/feat/doc</code>等。</p>
<h3 id="代码复用性"><a href="#代码复用性" class="headerlink" title="代码复用性"></a>代码复用性</h3><ul>
<li><p>拆分函数。做到“一个函数只负责一个功能”。比如说某个点击事件的回调，可能包括网络请求、改变状态、整理数据等多步，就把这几个不同的功能分别拆到不同的函数中。</p>
</li>
<li><p>自定义工具函数。</p>
<ul>
<li>对于可能重复使用的处理一段数据的代码，比如一个数组数据的 map、filter，抽象成一个函数</li>
<li>判断函数，比如 isXXX 类型的函数，用于代替条件判断</li>
<li>构造对象的函数，比如构造出的对象是某个函数的参数，或者是修改 state 的，将其抽象为一个函数甚至构造函数的函数。比如 xxxAction 和 createXXXAction</li>
<li>举例：深比较、深格式化数据、计算地图和真实点位对应</li>
</ul>
</li>
<li><p>自定义 hook：代码编写时，注意到某些 useState、useRef 以及 useEffect 的组合貌似是固定的，就将其抽出来成为一个自定义 hook。尤其是 useEffect。</p>
<ul>
<li>useMap：用于接收一个地图 id，调用一个外部 api，然后返回地图 url：</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> loadMap = (fileId: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">string</span>&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    resolve(imageUrl);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useMapUrl</span>(<span class="params">tenantId: <span class="built_in">string</span>, mapId: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [mapUrl, setMapUrl] = useState(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mapId &amp;&amp; mapId !== <span class="string">&quot;0&quot;</span>) &#123;</span><br><span class="line">      getMapDetail(mapId, tenantId, <span class="literal">false</span>)</span><br><span class="line">        .then(<span class="function">(<span class="params">map</span>) =&gt;</span> loadMap(map.png_file_id))</span><br><span class="line">        .then(setMapUrl);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [mapId, tenantId]);</span><br><span class="line">  <span class="keyword">return</span> mapUrl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>usePolling：轮询，虽然有现成的，但是自定义的原因是为了实现当 deps 变为 false 就停止轮询这个功能。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> usePolling = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  callback,</span></span></span><br><span class="line"><span class="params"><span class="function">  time: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  pollingDep?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  isImmidiate = <span class="literal">true</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> deps = pollingDep != <span class="literal">null</span> ? [pollingDep] : [];</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> interval = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (pollingDep === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isImmidiate) callback();</span><br><span class="line">    interval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      callback();</span><br><span class="line">    &#125;, time);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">  &#125;, deps);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>useImage：将 file 格式图片转为 base64，这个也很简单，在 useEffect 中调用 fr 即可：</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useImgBase64Url</span>(<span class="params">img: File</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [url, setUrl] = useState&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (img) &#123;</span><br><span class="line">      <span class="keyword">const</span> fr = <span class="keyword">new</span> FileReader();</span><br><span class="line">      fr.readAsDataURL(img);</span><br><span class="line">      fr.onload = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        setUrl(fr.result <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [img]);</span><br><span class="line">  <span class="keyword">return</span> url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>分割组件</p>
<ul>
<li>将具有自己独立状态的组件分割。比如一个 modal 内的表单，一个 drawer 内的 table 等，尽量让组件自己维护一些状态，不要全提升到父组件中</li>
<li>要复用的组件，比如四个 Modal，这四个 modal 虽然内部不一样，但是他们需要的外部数据基本一致（visible,robotData），内部结构也大体一致（都是一个 Alert + 一个表单），因此把表单抽成四个组件，Modal 就使用一个组件。</li>
</ul>
<p>如下所示，Modal 组件用 React.cloneElement 给子组件注入 props，这样子组件始终含有 robotData 等关键数据。子组件通过修改父组件 ref 的形式控制 modal 点击确定时提交表单（这里应该有更好的方式）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">export function MyModal(&#123;</span><br><span class="line">  robotData,</span><br><span class="line">  visible,</span><br><span class="line">  setVisible,</span><br><span class="line">  children,</span><br><span class="line">&#125;: ModalPropsType) &#123;</span><br><span class="line">  const onOk = useRef&lt;(e?: MouseEvent) =&gt; Promise&lt;any&gt;&gt;(async () =&gt; &#123;</span><br><span class="line">    setVisible(false);</span><br><span class="line">  &#125;);</span><br><span class="line">  return (</span><br><span class="line">    &lt;Modal</span><br><span class="line">      visible=&#123;visible&#125;</span><br><span class="line">      onCancel=&#123;() =&gt; setVisible(false)&#125;</span><br><span class="line">      onOk=&#123;onOk.current&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;React.cloneElement(children, &#123;</span><br><span class="line">        // 注入props</span><br><span class="line">        onOk,</span><br><span class="line">        robotData,</span><br><span class="line">        setVisible,</span><br><span class="line">      &#125;)&#125;</span><br><span class="line">    &lt;/Modal&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// MyModal不改变，只改变CreateUserForm即可。</span><br><span class="line">export function CreateUserForm(&#123;</span><br><span class="line">  onOk,</span><br><span class="line">  robotData,</span><br><span class="line">  setVisible,</span><br><span class="line">&#125;: CreateUserFormPropsType) &#123;</span><br><span class="line">  const [form] = Form.useForm();</span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    onOk.current = async () =&gt; &#123;</span><br><span class="line">      const res = await form.validate().catch(console.error);</span><br><span class="line">      console.log(res);</span><br><span class="line">      setVisible(false);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;Alert type=&quot;warning&quot; content=&#123;`$&#123;robotData.basic.device_name&#125;`&#125; /&gt;</span><br><span class="line">      &lt;Form form=&#123;form&#125;&gt;</span><br><span class="line">        &lt;Form.Item field=&quot;username&quot;&gt;</span><br><span class="line">          &lt;Input type=&quot;text&quot; max=&#123;20&#125; /&gt;</span><br><span class="line">        &lt;/Form.Item&gt;</span><br><span class="line">      &lt;/Form&gt;</span><br><span class="line">    &lt;/&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>代码规范：变量命名规范、函数命名规范、类型命名规范、导入语句、组件名、组件文件名等。</p>
<ul>
<li>eslint 限制代码规范：默认的 extends 和 plugin，比如 react、babel、@typescript-eslint 等</li>
<li>自定义 rules：<ul>
<li>禁用魔法数字</li>
<li>camelCase 强制变量名和对象属性为小驼峰</li>
<li>eqeqeq，配置<code>&#123;&quot;null&quot;: &quot;ignore&quot;&#125;</code></li>
</ul>
</li>
<li>eslint-plugin-filenames 可以限制文件名和目录名。比如：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span>: [<span class="string">&quot;filenames&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;filenames/match-regex&quot;</span>: [<span class="string">&quot;error&quot;</span>, <span class="string">&quot;^[a-z]+(-[a-z]+)*$&quot;</span>, <span class="literal">true</span>] <span class="comment">// 限制文件名为kebab-case形式</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="需求问题"><a href="#需求问题" class="headerlink" title="需求问题"></a>需求问题</h3><h5 id="canvas-问题"><a href="#canvas-问题" class="headerlink" title="canvas 问题"></a>canvas 问题</h5><p>首先是计算地图坐标和 canvas 坐标，相互转化<br>主要有以下几点：</p>
<ol>
<li>地图是一张图片，通过 drawImage 绘制到 canvas 上。这个过程中，绘制的大小，即传入的绘制宽高会导致图片放缩。所以要记录比例 scale</li>
<li>接口给出了地图的真实宽高、真实坐标原点的 xy 值，以及真实点位的坐标 xy 值。从真实坐标计算到 canvas 坐标就是<code>(真实点位x - 真实点位原点x)/比例尺 * 缩放比例</code>。</li>
</ol>
<p>这个地方比较抽象，不容易想到</p>
<p>还有就是获取 canvas 上鼠标点击事件的坐标，基本方法是用到了 getBoundingClientRect</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">&quot;myCanvas&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> ctx = canvas.getContext(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> rect = canvas.getBoundingClientRect();</span><br><span class="line">  <span class="keyword">const</span> x = event.clientX - rect.left;</span><br><span class="line">  <span class="keyword">const</span> y = event.clientY - rect.top;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Clicked at (<span class="subst">$&#123;x&#125;</span>, <span class="subst">$&#123;y&#125;</span>)`</span>);</span><br><span class="line">&#125;</span><br><span class="line">canvas.addEventListener(<span class="string">&quot;click&quot;</span>, handleClick);</span><br></pre></td></tr></table></figure>

<h5 id="konva"><a href="#konva" class="headerlink" title="konva"></a>konva</h5><ul>
<li>为什么选用？<ul>
<li>减少 canvas 代码，直接用命令式绘制，或者使用 react-konva，直接采用组件的形式，像写 html 一样</li>
<li>解决事件问题。这也是不选用其他库的一个原因，konva 有独特的事件系统。<br>其他选项有：<ul>
<li>Fabric：和 konva 类似，也有事件系统，但他和 react 的结合不如 konva 这种组件形式。</li>
<li>react-canvas：这个库非常老，已经没有人维护了</li>
</ul>
</li>
</ul>
</li>
<li>怎么用？</li>
<li>什么原理</li>
</ul>
<h5 id="recoil-和-redux"><a href="#recoil-和-redux" class="headerlink" title="recoil 和 redux"></a>recoil 和 redux</h5><ul>
<li>为什么用：组件拆分，零碎组件多，不用的话状态难以共享，context 太复杂</li>
<li>redux：框架自带。主要有一些问题：<ul>
<li>reducer 代码庞大。一个 reducer 只能维护一个状态，因此很多零散的状态就需要很多 reducer。如果把他们合并到一个 reducer，看起来很乱，并且会导致无谓的更新</li>
<li>组件内很难用。dispatch 传入的 action 不能得到类型，需要不停地返回去查看 action.type 名称；后来封装了创建 action 的函数，但是导致了更多的代码</li>
</ul>
</li>
<li>recoil：自行选择。主要目的：<ul>
<li>代码简洁</li>
<li>解决状态零碎问题，atom 本来就是推崇零碎状态。</li>
</ul>
</li>
</ul>
<h2 id="学到知识"><a href="#学到知识" class="headerlink" title="学到知识"></a>学到知识</h2><ul>
<li>技术选型：状态管理库的了解，redux、mobx 的原理、recoil 的优势，其他状态管理库之间的优劣比较</li>
<li>konva 的使用，konva 的事件原理和设计模式，react-konva 和 react 的结合方式</li>
<li>canvas api，canvas 基础功能的实现，canvas 优化</li>
<li>代码规范，四个方面的代码规范</li>
<li>工程化代码规范的方式（eslint、husky）</li>
</ul>
<h2 id="项目难点"><a href="#项目难点" class="headerlink" title="项目难点"></a>项目难点</h2><ol>
<li>事件冒泡规则。</li>
</ol>
<p>问题：<br>在项目中确实遇到了这样的问题：有一个这样的需求，即显示一个实时地图，实时地图内有很多点位，希望点击这些点位时，能获取到具体点的是哪个点位。<br>这是一个常见的事件委托的需求，但是需要事件冒泡作为基础。由于 konva 的事件系统是自己模拟实现的，因此与 dom 的事件机制不一样，在使用时出现了一些问题。</p>
<p>个人尝试：</p>
<ul>
<li>尝试把 onclick 事件放到实时地图的矩形上，发现虽然地图表现为“包裹”着点位，但是实际上不能触发冒泡</li>
<li>然后猜测可能是跟先后顺序有关，尝试后也无效。</li>
<li>最后猜测应该把实时点位作为地图的矩形的子元素，或者用一个大的元素包裹这两个元素，都不行</li>
<li>如果把事件绑定在 layer 或 stage 上，这两个上面已经有其他事件的绑定了，并且实时地图和实时点位是选择渲染的，不一定有，因此希望把事件绑定在实时地图容器上，而不是绑定在顶层。</li>
</ul>
<p>查阅资料：</p>
<ul>
<li>官方文档，有讲事件的部分，但是没有详述冒泡的规则，并且 react-konva 文档中也没有说事件流的相关概念</li>
<li>github issues：查找有关事件冒泡的 issues，没有，然后查找其他关于事件系统的 issues，也没有</li>
<li>最后，查看源码<ul>
<li>先是了解 konva 事件系统的实现原理<ul>
<li>调试源码</li>
<li>搜一些资料，查看事件原理</li>
</ul>
</li>
<li>然后搞清楚事件冒泡的机制：fireAndBubble，以及查找的“parent”到底是谁</li>
<li>最后了解到每个元素都有一个 parent，但是 parent 只在 Container 中被设置，并且必须调用 add 方法。Container 只有 stage、layer 和 group，普通元素不行。</li>
</ul>
</li>
</ul>
<p>解决方案</p>
<ul>
<li>在 Container 上放置事件监听。使用 Group 把实时地图和实时点位包裹起来，然后在 Group 上监听事件，即可。</li>
<li>同时还了解到了取消事件冒泡的机制，在 Group 上通过 cancelBubble 防止事件进一步冒泡</li>
</ul>
<ol start="2">
<li>地图拖动、点位的可视区域渲染，边界控制。（可以不说）</li>
</ol>
<p>问题<br>地图的底图比实际的 canvas 大小大很多，如果想显示完整的地图就有两种方式</p>
<ul>
<li>创建一个和底图一样大的 canvas，然后通过 css 的滚动条进行移动</li>
<li>canvas 大小固定，通过拖动的方式移动地图</li>
</ul>
<p>第一种的问题：过大的 canvas 会导致性能出现问题，比如分辨率不足、渲染负担重等问题。<br>解决方式：canvas 大小固定，改变渲染区间。</p>
<p>具体做法：</p>
<ul>
<li>首先创建固定大小的 canvas，然后把整个底图渲染上去。canvas 的大小不变，超出的区域是没有渲染的区域</li>
<li>实现拖动查看。具体功能点有<ul>
<li>基本的拖动，通过监听 mousemove 等事件，修改 canvas 的 translate，然后重新渲染，实现拖动效果</li>
<li>边界控制，不能让拖动超出底图的范围，因此拖动时计算边界，如果拖动时 offset 超出边界范围就不发生移动。</li>
<li>可视区域渲染：渲染所有点位时，先通过他们的坐标判断是否在可视区域，如果在才渲染，否则不进行渲染。</li>
</ul>
</li>
</ul>
<p>拖动的实现</p>
<p>基本思路：</p>
<ol>
<li>记录一个 offsetX 和 offsetY，表示 canvas 的 translate 值。每次绘制，都先<code>translate(offsetX,offsetY)</code>，然后执行绘制</li>
<li>监听 canvas 的 mousedown、mousemove 和 mouseup 事件，当 mousemove 执行时，获取实时的鼠标坐标，和 mousedown 时获取的鼠标坐标的差值就是偏移量，即 offsetX 和 offsetY。</li>
<li>通过修改之后的 offsetX 和 offsetX，如第一步操作。</li>
</ol>
<p>另外：react-konva 中的实现：</p>
<ul>
<li>其他方式基本不变，但是不需要自己手动绘制，只需要修改 layer 的 x 和 y 即可。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvasRef = useRef &lt; HTMLCanvasElement &gt; <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> mousePos = useRef([<span class="number">0</span>, <span class="number">0</span>]);</span><br><span class="line"><span class="keyword">const</span> mouseOffset = useRef([<span class="number">0</span>, <span class="number">0</span>]);</span><br><span class="line"><span class="keyword">const</span> currMouseOffset = useRef([<span class="number">0</span>, <span class="number">0</span>]);</span><br><span class="line"><span class="keyword">const</span> scale = useRef(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> preScale = useRef(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查点位是否在可视区域内</span></span><br><span class="line"><span class="keyword">const</span> isShapeVisible = <span class="function">(<span class="params">shapeX: number, shapeY: number</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [originX, originY] = mouseOffset.current;</span><br><span class="line">  <span class="keyword">const</span> [top, left, right, bottom] = [</span><br><span class="line">    -originY,</span><br><span class="line">    -originX,</span><br><span class="line">    -originX + width,</span><br><span class="line">    -originY + height,</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">return</span> shapeX &gt;= left &amp;&amp; shapeX &lt;= right &amp;&amp; shapeY &gt;= top &amp;&amp; shapeY &lt;= bottom;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> draw = <span class="function">(<span class="params">type: TranslateType</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 绘制前先translate</span></span><br><span class="line">  ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">  ctx.translate(mouseOffset.current[<span class="number">0</span>], mouseOffset.current[<span class="number">1</span>]);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 点位的数组，每一项绘制之前先检查当前点位是否在可视区域</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onMouseMove = useCallback(<span class="function">(<span class="params">e: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 获取移动的量，即当前鼠标位置减去初始鼠标位置</span></span><br><span class="line">  <span class="keyword">const</span> moveX = e.clientX - mousePos.current[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">const</span> moveY = e.clientY - mousePos.current[<span class="number">1</span>];</span><br><span class="line">  <span class="comment">// 边界控制</span></span><br><span class="line">  <span class="keyword">const</span> [x, y] = mouseOffset.current;</span><br><span class="line">  <span class="keyword">if</span> (x &gt; <span class="number">1</span> || y &gt; <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (x &lt; width - backgroundWidth || y &lt; height - backgroundHeight) <span class="keyword">return</span>;</span><br><span class="line">  mouseOffset.current = [</span><br><span class="line">    <span class="comment">// currMouseOffset用于记录已有的偏移，每次拖动理应在上一次偏移的基础上偏移</span></span><br><span class="line">    currMouseOffset.current[<span class="number">0</span>] + moveX,</span><br><span class="line">    currMouseOffset.current[<span class="number">1</span>] + moveY,</span><br><span class="line">  ];</span><br><span class="line">  draw();</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onMouseUp = useCallback(<span class="function">(<span class="params">e: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 记录本次的偏移量，下一次就以curr为基础。</span></span><br><span class="line">  currMouseOffset.current[<span class="number">0</span>] = mouseOffset.current[<span class="number">0</span>];</span><br><span class="line">  currMouseOffset.current[<span class="number">1</span>] = mouseOffset.current[<span class="number">1</span>];</span><br><span class="line">  canvasRef.current?.removeEventListener(<span class="string">&quot;mousemove&quot;</span>, onMouseMove);</span><br><span class="line">  canvasRef.current?.removeEventListener(<span class="string">&quot;mouseup&quot;</span>, onMouseUp);</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onMouseDown = useCallback(<span class="function">(<span class="params">e: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 设置一个初始鼠标位置</span></span><br><span class="line">  mousePos.current = [e.clientX, e.clientY];</span><br><span class="line">  canvasRef.current?.addEventListener(<span class="string">&quot;mousemove&quot;</span>, onMouseMove);</span><br><span class="line">  canvasRef.current?.addEventListener(<span class="string">&quot;mouseup&quot;</span>, onMouseUp);</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!canvasRef.current) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">const</span> canvas = canvasRef.current;</span><br><span class="line">  <span class="keyword">const</span> context = canvas.getContext(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">  draw();</span><br><span class="line">  canvas.addEventListener(<span class="string">&quot;mousedown&quot;</span>, onMouseDown);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<h2 id="其他注意点"><a href="#其他注意点" class="headerlink" title="其他注意点"></a>其他注意点</h2><ol>
<li>移动端？</li>
</ol>
<p>如果项目是在移动端的，可能需要什么样的操作使得地图可以在移动端正常使用？</p>
<ul>
<li>响应式：由于移动端屏幕大小不同，因此canvas大小可能需要改变</li>
<li>性能：移动端性能可能不如pc端，因此需要考虑更多的性能问题，比如web worker等，以及canvas的一些优化方式</li>
<li>操作：移动端操作事件和pc端不同（比如touch事件和mouse事件），需要做出适配</li>
<li>地图加载：可以采用压缩、地图分块加载等方式加快地图加载速度，这个也适用于pc端</li>
</ul>
<ol start="2">
<li>定位到机器人的问题</li>
</ol>
<p>还需要一个功能：把地图中心点定位到机器人的位置。核心其实还是通过控制 translate</p>
<ol start="3">
<li>部署？</li>
</ol>
<p>项目是怎么部署的？（这个可能有点来不及了）</p>
<ol start="4">
<li>长连接的方式</li>
</ol>
<p>除了轮询和 websocket，还可以怎么样保持地图的实时性？</p>
<ul>
<li>SSE：SSE 是一种基于 HTTP 协议的单向通信机制，它允许服务器向客户端推送事件流。客户端通过建立一个持久化的 HTTP 连接，从服务器接收事件数据。<br>SSE 通常适用于服务端推送少量数据给客户端。<br>SSE 的使用类似 websocket，但他发送数据的单位是事件流，即服务器端发送的响应内容应该使用值为 text/event-stream 的 MIME 类型。每个通知以文本块形式发送，并以一对换行符结尾。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> evtSource = <span class="keyword">new</span> EventSource(<span class="string">&quot;//api.example.com/ssedemo.php&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line">evtSource.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newElement = <span class="built_in">document</span>.createElement(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> eventList = <span class="built_in">document</span>.getElementById(<span class="string">&quot;list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  newElement.innerHTML = <span class="string">&quot;message: &quot;</span> + event.data;</span><br><span class="line">  eventList.appendChild(newElement);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>长轮询，不过不适用于本项目。</li>
</ul>
<ol start="5">
<li>项目中替换技术栈有什么工程化的方式？</li>
</ol>
<ul>
<li>渐进式替换，新的组件用新的技术栈，旧的组件用以前的</li>
<li>做好自测和 QA 的测试</li>
</ul>
<h1 id="秒杀平台项目"><a href="#秒杀平台项目" class="headerlink" title="秒杀平台项目"></a>秒杀平台项目</h1><p>遇到问题：</p>
<ul>
<li>请求数量大，请求需要添加 jwt，不能每次请求都配置一次；并且请求部分代码多，影响代码质量</li>
<li>首屏加载速度很慢，第一次加载可能等数秒才显示内容</li>
<li>针对模拟线上环境的优化，模拟秒杀系统应用场景</li>
</ul>
<p>项目重点：</p>
<ul>
<li>需要符合秒杀系统的应用场景，在前端做出优化。具体优化方向为减轻服务器负担，比如降低资源大小、减少请求次数等。</li>
<li>关于技术选型相关的，比如为什么采用原生 webpack 而不是 cra，cra 相比手动配优势在哪里，cra 做了哪些配置？</li>
<li>项目中 jwt 的使用，可能有刷新 token 的机制？</li>
<li>关于秒杀倒计时，怎么确定倒计时准确？</li>
</ul>
<h2 id="遇到问题-1"><a href="#遇到问题-1" class="headerlink" title="遇到问题"></a>遇到问题</h2><h3 id="请求数量大：请求封装"><a href="#请求数量大：请求封装" class="headerlink" title="请求数量大：请求封装"></a>请求数量大：请求封装</h3><p>参考超管项目的封装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">// 先创建实例</span><br><span class="line">const service = axios.create(&#123;</span><br><span class="line">  // 添加jwt头</span><br><span class="line">  headers: &#123;</span><br><span class="line">    &quot;Content-Type&quot;: &quot;application/json&quot;,</span><br><span class="line">    Authorization: `Bearer $&#123;api_cfg.token&#125;`,</span><br><span class="line">  &#125;,</span><br><span class="line">  timeout: 10000,</span><br><span class="line">  baseURL: api_cfg.apiUrl,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 添加响应拦截器</span><br><span class="line">service.interceptors.response.use(function (response) &#123;</span><br><span class="line">  // 进行状态码判断</span><br><span class="line">  const &#123; code, data = &#123;&#125; &#125; = response?.data;</span><br><span class="line">  if (code === 10001) &#123;</span><br><span class="line">    Message.error(&quot;你的token已失效，请重新登录!&quot;);</span><br><span class="line">    setTimeout(() =&gt; &#123;</span><br><span class="line">      if (window.location.pathname !== &quot;/login&quot;) &#123;</span><br><span class="line">        window.location.href = &quot;/login&quot;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, 1000);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return response;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 封装请求方法request</span><br><span class="line">// 接收泛型作为返回值类型</span><br><span class="line">export default function request&lt;T = unknown&gt;(</span><br><span class="line">  opts: AxiosRequestConfig, // 请求对象，即url、method、data、params等属性</span><br><span class="line">  notify = true</span><br><span class="line">): Promise&lt;T&gt; &#123;</span><br><span class="line">  return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    const reqFn = async () =&gt; &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        const res = await service(opts);</span><br><span class="line">        // 这里是service正常resolve的处理，即收到了响应，但可能有误</span><br><span class="line">        const &#123; code, data = &#123;&#125; &#125; = res?.data;</span><br><span class="line">        // 这里只处理了部分类型的结果</span><br><span class="line">        if (res.status === 200 &amp;&amp; code === 0) &#123;</span><br><span class="line">          return resolve(data);</span><br><span class="line">        &#125; else if (code === 71002) &#123;</span><br><span class="line">          // 约定：如，服务端错误</span><br><span class="line">          return reject(res?.data);</span><br><span class="line">          // 还可以加几个，比如状态码404，403的处理，或者约定的code的处理</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // 其他情况统一reject</span><br><span class="line">          // 通过message组件全局提醒报错</span><br><span class="line">          return reject(res?.data?.msg);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (err) &#123;</span><br><span class="line">        // service执行错误，即根本没收到响应，比如跨域、网络中断、400/500等错误</span><br><span class="line">        // 通过message组件全局提醒报错</span><br><span class="line">        console.error(err);</span><br><span class="line">        return reject(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    reqFn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后具体到每个请求，具体封装：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义类型：请求体类型，响应data类型</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getBuildingInfo = <span class="function">(<span class="params">building_id: <span class="built_in">string</span></span>) =&gt;</span></span><br><span class="line">  request&lt;DtoGetBuildingInfoResp&gt;(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/admin/api/v1/admin/building&quot;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">    <span class="attr">params</span>: &#123; building_id &#125;,</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>有一个缺点是 request 函数还是会 reject，也就是具体函数还是要具体处理错误。<br>其实这样更好，因为不同上下文调用的函数可能错误处理不同，如果请求出错不是预设错误的话，就应该直接 reject。</p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><h4 id="优化内容总"><a href="#优化内容总" class="headerlink" title="优化内容总"></a>优化内容总</h4><ol>
<li>代码分割。代码分割的目的有两个：</li>
</ol>
<ul>
<li>缓存</li>
<li>优化代码体积，加快加载速度。</li>
</ul>
<p>代码分割的方式：</p>
<ul>
<li>动态加载，使用 React.lazy 包裹页面组件。</li>
<li>splitChunk，分割 vendor</li>
<li>分割 css</li>
</ul>
<ol start="2">
<li>开发模式优化</li>
</ol>
<ul>
<li>持久化缓存</li>
<li>sourcemap 配置 eval-cheap-module-source-map</li>
<li>关闭生产模式优化</li>
</ul>
<ol start="3">
<li>生产模式优化</li>
</ol>
<ul>
<li>代码压缩，css、js 压缩</li>
<li>tree-shaking</li>
<li>利用 import 对图片等资源进行 prefetch</li>
</ul>
<ol start="4">
<li>其他优化</li>
</ol>
<ul>
<li>图片：<ul>
<li>webp 格式：webp-webpack-plugin</li>
<li>压缩：image-minimizer-webpack-plugin</li>
</ul>
</li>
<li>loader：自己编写的 loader</li>
<li>按需导入 antd 的组件和 css<ul>
<li>组件：默认支持 tree-shaking</li>
<li>样式：使用 babel-plugin-import 的 style 配置来引入样式。参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/zwkkkk1/article/details/88823366%E5%92%8Chttps://juejin.cn/post/7117293855958892574">https://blog.csdn.net/zwkkkk1/article/details/88823366和https://juejin.cn/post/7117293855958892574</a></li>
</ul>
</li>
<li>骨架屏</li>
</ul>
<h4 id="针对线上环境的优化"><a href="#针对线上环境的优化" class="headerlink" title="针对线上环境的优化"></a>针对线上环境的优化</h4><p>核心：请求优化</p>
<ul>
<li>减小请求大小</li>
<li>降低请求次数</li>
</ul>
<ol>
<li><p>减小请求大小，即减小打包产物大小，上述的所有压缩等减小体积的方法</p>
</li>
<li><p>降低请求次数：</p>
</li>
</ol>
<ul>
<li>充分利用缓存</li>
<li>分包不要太细碎</li>
<li>部分数据持久化，比如秒杀到期时间戳不用频繁同步</li>
<li>秒杀接口的节流处理，多次点击只会生效一次</li>
</ul>
<h4 id="其他方面优化"><a href="#其他方面优化" class="headerlink" title="其他方面优化"></a>其他方面优化</h4><p>这些优化方式并不一定是显式的优化，更多的是一种提升项目健壮性的方式</p>
<ol>
<li>针对可能的服务端问题：做好对服务端处理速度缓慢或对服务端崩溃的处理，比如</li>
</ol>
<ul>
<li>购买链接设置足够长的超时时间，或者通过倒计时，当时间到的时候加长超时时间。</li>
<li>采用合适的loading方式，使得用户请求之后不能再请求，相当于一种节流的方式</li>
<li>告知用户加载可能很慢等</li>
<li>如果服务器崩溃导致不能正常显示，要采取fallback措施，比如服务端返回特定的错误码时（500/504）提示好用户，并暂时关闭购买按钮，设置定时器在一段时间后再开始</li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/codes1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/11/blog8-react-source-code/"><img class="prev-cover" src="/img/react.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">react原理浅析学习</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/13/blog10-handwriting/"><img class="next-cover" src="/img/JS.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">js手写</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/pinkstar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Xing Ye</div><div class="author-info__description">a singleThreaded boy's blog</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/penghei"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/penghei" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:632885485@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">A SingleThreaded Boy...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B6%85%E7%AE%A1%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">超管项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">遇到问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.1.</span> <span class="toc-text">代码规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">命名规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ts-%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">ts 规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#react-%E9%A1%B9%E7%9B%AE%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">react 项目规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#git-%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">git 规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eslint"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">eslint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#husky"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">husky</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%A4%8D%E7%94%A8%E6%80%A7"><span class="toc-number">1.1.2.</span> <span class="toc-text">代码复用性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.3.</span> <span class="toc-text">需求问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#canvas-%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.3.0.1.</span> <span class="toc-text">canvas 问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#konva"><span class="toc-number">1.1.3.0.2.</span> <span class="toc-text">konva</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#recoil-%E5%92%8C-redux"><span class="toc-number">1.1.3.0.3.</span> <span class="toc-text">recoil 和 redux</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E5%88%B0%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.</span> <span class="toc-text">学到知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%9A%BE%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">项目难点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">1.4.</span> <span class="toc-text">其他注意点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.</span> <span class="toc-text">秒杀平台项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98-1"><span class="toc-number">2.1.</span> <span class="toc-text">遇到问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%95%B0%E9%87%8F%E5%A4%A7%EF%BC%9A%E8%AF%B7%E6%B1%82%E5%B0%81%E8%A3%85"><span class="toc-number">2.1.1.</span> <span class="toc-text">请求数量大：请求封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.2.</span> <span class="toc-text">优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%86%85%E5%AE%B9%E6%80%BB"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">优化内容总</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">针对线上环境的优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">其他方面优化</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/07/08/stereotype-methodical-answer/" title="无题"><img src="/img/codes1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/07/08/stereotype-methodical-answer/" title="无题">无题</a><time datetime="2023-07-07T18:59:52.468Z" title="发表于 2023-07-08 02:59:52">2023-07-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/08/stereotype/" title="无题"><img src="/img/codes1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/07/08/stereotype/" title="无题">无题</a><time datetime="2023-07-07T18:59:52.445Z" title="发表于 2023-07-08 02:59:52">2023-07-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/08/readme/" title="无题"><img src="/img/codes1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/07/08/readme/" title="无题">无题</a><time datetime="2023-07-07T18:59:52.412Z" title="发表于 2023-07-08 02:59:52">2023-07-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/08/react-priority/" title="无题"><img src="/img/codes1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/07/08/react-priority/" title="无题">无题</a><time datetime="2023-07-07T18:59:52.357Z" title="发表于 2023-07-08 02:59:52">2023-07-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/08/RACF-optimization/" title="无题"><img src="/img/codes1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/07/08/RACF-optimization/" title="无题">无题</a><time datetime="2023-07-07T18:59:52.304Z" title="发表于 2023-07-08 02:59:52">2023-07-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Xing Ye</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hello stranger!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>